import os
import time
import pyautogui
from pygetwindow import getWindowsWithTitle

# ============= 必须配置的坐标参数 =============
# 通过坐标校准工具获取以下关键坐标：
SEARCH_BOX_POS = (2500, 20)  # 搜索框点击坐标（需手动校准）
CLEAR_ICON_POS = (2500, 20)  # 搜索框清除按钮坐标（小叉图标）
STOCK_PAGE_CHECK_POS = (600, 400)  # 页面加载标识坐标（如最新价区域）
# =============================================

# ============= 运行时参数 ================
STOCK_LIST =["600519","601398","600941","601939","601628","601288","300750","600036",
             "601988","601857","601318","002594","600938","000858","601088","600028",
             "600900","601888","601658","300760","601728","603288","601166","000333",
             "601328","600809","688981","601012","002415","000568","600030","600309",
             "002352","002714","601899","601633","300059","000001","600276","601998",
             "002304","603259","601816","300999","600690","601601","002475","601319",
             "601668","300015","002142","600000","000002","600887","300124","601995",
             "601066","300014","688235","000651","601138","600048","601225","600438",
             "600436","600406","600188","600104","601818","601919","600905","300274",
             "601111","001289","600016","688271","688223","600600","600585","601766",
             "002460","600050","600009","000596","300122","002459","688599","601390",
             "600029","003816","600031","002466","601800","000725","600019","300498",
             "002493","000792","688111","600018","300896","002129","000625","000063",
             "601211","002371","002812","600025","000776","600011","603392","601688",
             "600999","601238","600760","601898","002049","601985","600893",
             "600346","600919","601009","601669","601186","600115","688303","600150",
             "002311","000166","603993","001979","601006","000538","002027","600196",
             "688041","601881","601868","002179","603501","300347","600111","600660",
             "601169","601336","603260","603799","603806","002709","000338","000895",
             "600010","600989","000301","000708","600703","002736","600547","300316",
             "601229","603195","600015","000963","601100","002271","600588","600845",
             "300759","601989","600886","600221","605117","601808","002230","688187",
             "600570","601600","600926","002050","600089","603659","600958","002180",
             "603833","600795","000877","300751","688008","601865","000617","002410",
             "600426","605499","688396","000768","600233","603986","600039","601018",
             "601788","000661","601607","300763","300979","600875","600745","601618",
             "688363","601689","300450","300142","603369","300957","002938","000100",
             "300661","600754","688036","601916","601021","300782","600132","688012",
             "601727","600085","688180","600362","000733","002920","601127","300408",
             "601877","000425","600256","601615","688385","000876","002001","002241",
             "600026","600515","600027","601825","300413","603290","601838","000938",
             "002821","300628","600522","600176","600741","300033","600674","600702",
             "300433","002074","601901","002648","002603","688032","603899","601991",
             "688009","601699","600803","603198","601377","600332","301269","603688",
             "601117","600763","601698","688126","000983","603605","603345","688063",
             "300454","001965","300496","000157","600460","601360","002202","000999",
             "601155","600383","603939","688777","603606","601872","600765","600023",
             "002601","300919","688114","688122","600372","300003"]

FUTU_WINDOW_TITLE = "富途牛牛"
SCREENSHOT_REGION = (0, 0, 3840, 2160)  # (x,y,width,height)
SAVE_DIR = r"E:\图片\市值300资金历史记录\2025市值A股资金历史记录\2025年05月市值300A股资金历史记录\2025年05月06日市值300A股资金历史记录"  # ← 新增路径定义


# ========================================

def get_futu_window():
    """精确获取窗口对象"""
    wins = [w for w in getWindowsWithTitle(FUTU_WINDOW_TITLE) if w.visible]
    if not wins:
        raise Exception("窗口未找到，请：1.保持窗口可见 2.标题包含'富途牛牛'")
    window = wins[0]
    if window.isMinimized:
        window.restore()
    return window


def force_click(pos, clicks=1):
    """强制执行鼠标点击"""
    x, y = pos
    pyautogui.moveTo(x, y, duration=0.3)
    pyautogui.click(clicks=clicks, interval=0.2)


def capture_stock_screenshots():
    # 初始化环境
    os.makedirs(SAVE_DIR, exist_ok=True)
    futu_win = get_futu_window()
    current_date = time.strftime("%Y-%m-%d")  # 获取当前日期

    for idx, stock in enumerate(STOCK_LIST, start=1):  # 使用enumerate生成序号
        try:
            # ==== 阶段1：准备搜索环境 ====
            futu_win.activate()
            time.sleep(0.4)

            # 物理点击搜索框（比快捷键更可靠）
            force_click(SEARCH_BOX_POS)
            time.sleep(0.4)

            # 清空历史记录（通过点击清除按钮）
            force_click(CLEAR_ICON_POS)
            time.sleep(0.4)

            # ==== 阶段2：输入股票代码 ====
            pyautogui.write(stock)
            time.sleep(0.4)
            pyautogui.press("enter")
            print(f"已输入 {stock} 等待加载...")

            # ==== 阶段3：智能等待 ====
            # 方式一：颜色轮询检测（检测价格区域刷新）
            for _ in range(20):  # 最多等待10秒
                r, g, b = pyautogui.pixel(*STOCK_PAGE_CHECK_POS)
                # 如果颜色不是灰色底色（假设加载完成区域变白）
                if (r, g, b) != (240, 240, 240):
                    break
                time.sleep(0.4)
            else:
                raise Exception("页面加载超时")

            # ==== 阶段4：精确截图 ====
            # 偏移截图范围（需配合窗口位置）
            win_left, win_top = futu_win.left, futu_win.top
            region = (
                win_left + SCREENSHOT_REGION[0],
                win_top + SCREENSHOT_REGION[1],
                SCREENSHOT_REGION[2],
                SCREENSHOT_REGION[3]
            )

            # 生成带日期和序号的文件名
            filename = os.path.join(SAVE_DIR, f"{current_date}_${idx}.png")  # 修改此行
            pyautogui.screenshot(filename, region=region)
            print(f"√ 成功截图：{filename}")

        except Exception as e:
            print(f"! {stock} 处理失败：{str(e)}")
            continue


if __name__ == "__main__":
    pyautogui.PAUSE = 0.5  # 降低操作速率为人类可识别
    capture_stock_screenshots()
 # 新增打开Z盘目录指令（在原有E盘目录基础上修改盘符）
    #z_save_dir = SAVE_DIR.replace("E:", "Z:", 1)
    os.startfile(SAVE_DIR)    # 原始E盘目录
    #os.startfile(z_save_dir)  # 新增Z盘目录
    # 执行C:\Users\Administrator\Desktop目录下的打开网盘.bat命令
    bat_path = r"C:\Users\Administrator\Desktop\每日统计改名\打开网盘.bat"
    try:
        os.startfile(bat_path)
        print(f"成功执行 {bat_path}")
    except Exception as e:
        print(f"执行 {bat_path} 时出错: {e}")